# Updates for vtkDepthSortPolyData #
this is a test harness used to profile and optimize
vtkDepthSortPolyData. The main is in *ds.cpp* and the
optimized code is in *vtkDepthSortPolyData2.cxx* *vtkPolyData*
has been patched.

## Compiling ##
I assume you make a directory called bin inside the source and
cd into it.

Becasuse some of the optimization require specific compiler flags
use the shell script to configure. You might have to change these
flags for your system. Use the same flags to build VTK if you desire
a fair comparison.

`../configure.sh
make`

## Running ##
Pass "1" for old code or "2" for new code on the command line and
input and output file names. Time to run the depth sort is sent to
the stderr. Use "" for output if you want to skip writing the result.

`./ds 1 ../iso.vtk ""
./ds 2 ../iso.vtk ""`

## Optimizations ##
vtkDepthSortPolyData was changed as follows:
* transfrom GetCell to GetCellPoints. Building the cell is expensive
  and we only need points to determine the depth. We can also then
  access the points in place.
* transform qsort to std::sort. Comparisons in std::sort get inlined.
* use templates to deal with point types instead of going through
  virtual GetValue API
* restructure bounds computations so that it can be vectorized
  by the compiler.
* Allocate the exact amount of memmory for the output and
  build the output without using virtual API

vtkPolyData was changed as follows:
* inline the non-virtual overload of GetCellPoints.
* avoid virtual API in BuildCells
* add a NeedToBuildCells to check that fast API can safely be used

## Test Data ##
Test data is in the file *iso.vtk*. This file contains 10 iso-surfaces
generated by ParaView using a 256^3 cosmology simulation. There are 2
scalar fields, 8.1M cells, and 4.1M points. The file is approx 250MB.
It is too large to store in github, so I split it into 50M files. The
config.sh script will merge them.

## Results ##
![comparison](images/depth_sort_speedup.png)


code | point | bounds | param
-----|-------|--------|------
old | 2.58 | 3.05 | 3.19
new | 0.82 | 1.02 | 1.65
speed up | 3.14 | 2.98 | 1.93

